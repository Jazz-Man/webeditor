var crsaPageUid = 1;
var CrsaPageTemplate = function () {
    this.type = null;
    this.header = null;
    this.html = null;
    this.detect = function (source) {
        if (source.indexOf("---") != 0)return false;
        var a = source.split("---");
        if (a.length < 3)return false;
        this.type = "liquid";
        this.header = "---" + a[1] + "---";
        a.splice(0, 2);
        this.html = a.length == 1 ? a[0] : a.join("---");
        return true
    };
    this.getTemplateSource = function (full_html) {
        if (!this.type)return full_html;
        return this.header + "\n" + full_html
    };
    this.getHtml = function () {
        return this.html
    }
};
var CrsaPage = function () {
    this.url = null;
    this.name = null;
    this.localFile = null;
    this.localFileWatcher = null;
    this.lastSavedAt = 0;
    this.$iframe = null;
    this.$page = null;
    this.loading = false;
    this.changed = true;
    this.force_close = false;
    this.live_update = null;
    this.save_parent = false;
    this.uid = crsaPageUid++;
    this.undoStack = new CrsaPageUndoStack(this);
    this.undoSetFlag = false;
    this.exists = false;
    this.crsaProjectTemplate = null;
    this.allowReload = false;
    this.readOnly = false;
    this.treeTop = null;
    this.treeRepaintOnShow = null;
    this.treeCurrentRoot = null;
    this.load_source = null;
    this.frameworks_added = false;
    this.breakpoints = [];
    this.sourceNode = null;
    this.scrollMode = crsaGetCustomLogic().scrollMode;
    this.deviceWidth = 1024;
    this.template = new CrsaPageTemplate;
    this.frameworks = [];
    this.animationsStopped = false;
    this.assetsCache = {};
    this.setLocalFile = function (file) {
        if (isApp()) {
            this.stopWatchingFileForChanges()
        }
        this.localFile = file;
        if (isApp()) {
            this.watchFileForChanges()
        }
    };
    this.scrollToPage = function () {
        scrollCanvasToPage(this.$iframe)
    };
    this.watchFileOnFileChanged = function (curr, prev) {
        var fs = require("fs");
        var updatePage = function () {
            var v = fs.readFileSync(_this.localFile, {encoding: "utf8"});
            var ret = _this.applyChangesToSource(v, false, false, true);
            if (ret.updated) {
                crsaQuickMessage("Auto refreshed!");
                if (ret.changes && ret.changes.length == 1) {
                    var $el = _this.getElementWithPgId(ret.changes[0].changed.getId());
                    if ($el) {
                        pinegrow.selectElement($el);
                        pinegrow.scrollCanvasToElement($el)
                    }
                }
            } else if (ret.changes && !ret.update) {
                _this.refresh()
            }
            _this.setPageChanged(false)
        };
        if (curr.mtime > prev.mtime && !_this.live_update && pinegrow.getSetting("auto-reloading", "1") == "1") {
            var ct = (new Date).getTime();
            if (ct - _this.lastSavedAt > 5e3) {
                console.log(_this.localFile + " changed");
                if (_this.watchReloadDialog) {
                    try {
                        _this.watchReloadDialog.modal("hide");
                        _this.watchReloadDialog = null
                    } catch (err) {
                    }
                }
                if (_this.changed) {
                    _this.watchReloadDialog = showAlert("<p><b>" + _this.name + "</b> was modified outside of Pinegrow. The file has unsaved changes. Do you want to reload it?</p><p><em>You can disable auto-reloading in Support -&gt; Settings.</em></p>", "Unsaved file modified outside of Pinegrow", "Don't reload", "Reload", function () {
                        _this.watchReloadDialog = null
                    }, function () {
                        _this.watchReloadDialog = null;
                        updatePage()
                    })
                } else {
                    updatePage()
                }
            } else {
            }
        }
    };
    this.isWatchingFileForChanges = false;
    this.watchReloadDialog = null;
    this.watchFileForChanges = function () {
        if (this.localFile && pinegrow.getSetting("auto-reloading", "1") == "1") {
            var fs = require("fs");
            this.localFileWatcher = fs.watchFile(this.localFile, {
                persistent: true,
                interval: 1102
            }, this.watchFileOnFileChanged);
            this.isWatchingFileForChanges = true
        }
    };
    this.stopWatchingFileForChanges = function () {
        if (this.localFile && this.isWatchingFileForChanges) {
            var fs = require("fs");
            fs.unwatchFile(this.localFile, this.watchFileOnFileChanged);
            this.isWatchingFileForChanges = false
        }
    };
    this.getAsset = function (url) {
        if (url in this.assetsCache)return this.assetsCache[url];
        return null
    };
    this.addAsset = function (url, data) {
        this.assetsCache[url] = data
    };
    this.clearAssetsCache = function () {
        this.assetsCache = {}
    };
    var _this = this;
    var pageChangedTimer = null;
    var cssid = "crsa-inline-styles";
    var componentTypes = null;
    var componentTypesDict = {};
    var libSections = null;
    var actionsSections = null;
    var onServerPageLoaded = function (event, obj) {
        var m = obj.url.match(/pgid=([0-9]+)/);
        if (m) {
            var pageid = parseInt(m[1]);
            if (pageid == _this.uid) {
                console.log("Source loaded " + obj.url);
                _this.sourceNode = obj.rootNode
            }
        }
    };
    if (pinegrow.sourceParser) {
        $("body").on("crsa-server-page-loaded", onServerPageLoaded)
    }
    this.getPageUrlFromLoadedUrl = function (url) {
        url = pinegrow.getOriginalUrl(url);
        url = url.replace(/&*pgid=[0-9]+/, "");
        url = url.replace("?pgedit=1", "").replace("&pgedit=1", "").replace("pgedit=1", "");
        if (url.length && url.charAt(url.length - 1) == "?") {
            url = url.substr(0, url.length - 1)
        }
        return url
    };
    this.getPreviewUrl = function (noids) {
        var url = crsaMakeUrlAbsolute(this.url);
        var a = ["pgid=" + this.uid, "pglive=1"];
        if (noids)a.push("pgnoids=1");
        url = crsaAppendQueryToUrl(url, a);
        url = pinegrow.getProxyUrl(url);
        return url
    };
    var resetFrameworksCache = function () {
        componentTypes = null;
        libSections = null;
        actionsSections = null
    };
    this.getComponentTypes = function () {
        if (!componentTypes) {
            componentTypes = [];
            for (var i = 0; i < this.frameworks.length; i++) {
                var f = this.frameworks[i];
                if (f.not_main_types)continue;
                $.each(f.getComponentTypes(), function (key, def) {
                    componentTypes.push(def)
                })
            }
            componentTypes.sort(function (a, b) {
                return a.priority - b.priority
            });
            componentTypesDict = {};
            $.each(componentTypes, function (i, def) {
                if (!componentTypesDict[def.type]) {
                    componentTypesDict[def.type] = def
                }
            })
        }
        return componentTypes
    };
    this.getPageStylesheets = function () {
        return getCrsaPageStylesForPage(this.$iframe)
    };
    this.getPageStylesheet = function (re) {
        var list = this.getPageStylesheets();
        for (var i = 0; i < list.length; i++) {
            if (typeof re == "string") {
                if (list[i].url == re)return list[i]
            } else {
                if (list[i].url.match(re))return list[i]
            }
        }
        return null
    };
    this.addStylesheet = function (url, update_list) {
        if (this.getPageStylesheet(url))return;
        var code = '<link rel="stylesheet" href="' + url + '">';
        var head = new pgQuery(this.get$Html().find("head"));
        var link = (new pgQuery).create(code);
        head.append(link);
        if (update_list)this.updateStylesheetsList()
    };
    this.updateStylesheetsList = function (done) {
        $.fn.crsacss("loadLessStyles", _this.$iframe.get(0), function () {
            $("body").trigger("crsa-stylesheets-changed");
            _this.addCrsaStyles();
            if (done)done()
        })
    };
    this.getTypeDefinition = function (type) {
        if (componentTypesDict == null) {
            this.getComponentTypes()
        }
        return componentTypesDict[type] ? componentTypesDict[type] : null
    };
    this.hasStylesheet = function (re) {
        var doc = this.$iframe.get(0).contentDocument || this.$iframe.get(0).contentWindow.document;
        for (var i = 0; i < doc.styleSheets.length; i++) {
            var sheet = doc.styleSheets[i];
            if (sheet.href) {
                if (sheet.href.match(re))return true
            }
        }
        return false
    };
    this.hasScript = function (re) {
        var doc = this.$iframe.get(0).contentDocument || this.$iframe.get(0).contentWindow.document;
        var found = false;
        $(doc).find("script[src]").each(function (i, s) {
            var src = $(s).attr("src");
            if (src && src.match(re)) {
                found = true;
                return false
            }
        });
        return found
    };
    this.getLibSections = function () {
        if (!libSections) {
            libSections = [];
            for (var i = 0; i < this.frameworks.length; i++) {
                var f = this.frameworks[i];
                $.each(f.getLibSections(), function (i, section) {
                    libSections.push(section)
                })
            }
        }
        return libSections
    };
    this.getActionsSections = function () {
        if (!actionsSections) {
            actionsSections = [];
            for (var i = 0; i < this.frameworks.length; i++) {
                var f = this.frameworks[i];
                $.each(f.getActionsSections(), function (i, section) {
                    actionsSections.push(section)
                })
            }
        }
        return actionsSections
    };
    this.getAllTypes = function ($el, pgel, skip_actions) {
        var r = [];
        for (var i = 0; i < this.frameworks.length; i++) {
            var f = this.frameworks[i];
            var a = f.getTypes($el, pgel, skip_actions);
            if (a.length) {
                r = r.concat(a)
            }
        }
        return r
    };
    this.getAllActionTypes = function ($el, pgel) {
        var r = [];
        for (var i = 0; i < this.frameworks.length; i++) {
            var f = this.frameworks[i];
            if (f.getActionTypes) {
                var a = f.getActionTypes($el, pgel);
                if (a.length) {
                    r = r.concat(a)
                }
            }
        }
        return r
    };
    this.getActionTag = function ($el) {
        for (var i = 0; i < this.frameworks.length; i++) {
            var f = this.frameworks[i];
            if (f.getActionTag)return f.getActionTag($el)
        }
        return null
    };
    this.detectAndAddFrameworks = function () {
        var info = this.getPageInfo();
        var added_types = [];
        var template_frameworks = [];
        if (this.crsaProjectTemplate) {
            template_frameworks = this.crsaProjectTemplate.frameworks
        }
        this.frameworks = [];
        var addFramework = function (f) {
            if (_this.frameworks.indexOf(f) < 0) {
                _this.frameworks.unshift(f);
                if (f.type)added_types.push(f.type)
            }
        };
        if (template_frameworks.length > 0) {
            $.each(pinegrow.getFrameworks(), function (key, f) {
                if (template_frameworks.indexOf(key) >= 0) {
                    addFramework(f)
                }
            })
        }
        $.each(pinegrow.getFrameworks(), function (key, f) {
            if (info && info.frameworks) {
                if (info.frameworks.indexOf(f.key) >= 0) {
                    addFramework(f)
                }
            } else if (f.default) {
                addFramework(f)
            } else if (f.detect && _this.sourceNode) {
                if (f.detect(_this)) {
                    if (f.type && added_types.indexOf(f.type) >= 0) {
                        return true
                    }
                    addFramework(f);
                    crsaQuickMessage(f.name + " detected.", 2e3)
                }
            }
        });
        if (info && info.frameworks) {
            var missing = [];
            for (var i = 0; i < info.frameworks.length; i++) {
                var found = false;
                for (var j = 0; j < _this.frameworks.length; j++) {
                    if (_this.frameworks[j].key == info.frameworks[i]) {
                        found = true;
                        break
                    }
                }
                if (!found) {
                    missing.push(info.frameworks[i])
                }
            }
            if (missing.length) {
                $.each(pinegrow.getFrameworks(), function (key, f) {
                    if (f.default) {
                        addFramework(f)
                    } else if (f.detect) {
                        if (f.detect(_this)) {
                            if (f.type && added_types.indexOf(f.type) >= 0) {
                                return true
                            }
                            addFramework(f);
                            crsaQuickMessage(f.name + " detected.", 2e3)
                        }
                    }
                })
            }
        }
        resetFrameworksCache();
        this.frameworks_added = true;
        var pi = this.getProjectInfo();
        if (pi && pi.breakpoints && pi.breakpoints.length) {
            this.breakpoints = pi.breakpoints;
            $("body").trigger("crsa-breakpoints-changed")
        }
    };
    this.findFrameworkOfType = function (type) {
        for (var i = 0; i < this.frameworks.length; i++) {
            if (this.frameworks[i].type === type)return this.frameworks[i]
        }
        return null
    };
    this.hasFramework = function (f) {
        return this.frameworks.indexOf(f) >= 0
    };
    this.canAddFramework = function (fm) {
        if (fm.allow_single_type && fm.type) {
            var efm = this.findFrameworkOfType(fm.type);
            if (efm)return false
        }
        return true
    };
    this.addFramework = function (fm) {
        var idx = this.frameworks.indexOf(fm);
        if (idx < 0) {
            if (!this.canAddFramework(fm))return false;
            this.frameworks.unshift(fm);
            pinegrow.frameworksChanged();
            this.callFrameworkHandler("on_plugin_activated");
            this.addCrsaStyles();
            return true
        }
        return true
    };
    this.frameworksChanged = function () {
        resetFrameworksCache()
    };
    this.removeFramework = function (fm) {
        var idx = this.frameworks.indexOf(fm);
        if (idx >= 0) {
            this.frameworks.splice(idx, 1);
            resetFrameworksCache();
            $("body").trigger("crsa-frameworks-changed");
            this.addCrsaStyles()
        }
    };
    var arraysEqual = function (a, b) {
        var i = a.length;
        if (i != b.length)return false;
        while (i--) {
            if (a[i] !== b[i])return false
        }
        return true
    };
    this.copyContentOfPage = function (crsaPage) {
        var ret = this.applyChangesToSource(crsaPage.sourceNode, false, true, pinegrow.getSelectedPage() == this);
        if (ret.changes && !ret.updated) {
            this.refresh()
        }
        return;
        var sBody = getIframeBody(crsaPage.$iframe.get(0));
        var dBody = getIframeBody(_this.$iframe.get(0));
        var pgSb = getElementPgNode($(sBody));
        var pgDb = getElementPgNode($(dBody));
        var html = sBody.innerHTML;
        var pgid;
        if (pgSb && pgDb) {
            var pgNb = pgSb.clone();
            pgDb.replaceWith(pgNb);
            html = pgNb.html(null, true);
            pgid = pgNb.getOrAssignId()
        }
        html = removeCrsaClassesFromHtml(html).replace(/contenteditable="true"/g, "");
        dBody.innerHTML = html;
        var attributes = $.map(dBody.attributes, function (item) {
            return item.name
        });
        $.each(attributes, function (i, item) {
            $(dBody).removeAttr(item)
        });
        $.each(sBody.attributes, function (idx, attr) {
            if (attr.nodeName != "data-pg-id") {
                $(dBody).attr(attr.nodeName, attr.nodeValue)
            }
        });
        $(dBody).attr("data-pg-id", pgid)
    };
    var copyContentFromPage = function (crsaPage) {
        if (pageChangedTimer) {
            clearTimeout(pageChangedTimer)
        }
        pageChangedTimer = setTimeout(function () {
            _this.copyContentOfPage(crsaPage);
            if (!_this.readOnly) {
                $.fn.crsa("buildTree", _this.$iframe);
                _this.treeRepaintOnShow = true
            }
            pageChangedTimer = null;
            if (!arraysEqual(_this.breakpoints, crsaPage.breakpoints)) {
                _this.setAllBreakpoints(crsaPage.breakpoints);
                $("body").trigger("crsa-breakpoints-changed")
            }
            _this.autoSize();
            _this.setPageChanged(true)
        }, 500)
    };
    this.onPageChanged = function (crsaPage) {
        copyContentFromPage(crsaPage)
    };
    this.setPageChanged = function (val, force) {
        if (this.live_update && this.save_parent)val = false;
        if (this.changed != val || force) {
            this.changed = val;
            var p = this.$page.find(".page-changed");
            if (this.changed) {
                p.show()
            } else {
                p.hide()
            }
        }
    };
    this.getMirroredPages = function () {
        var r = [];
        for (var i = 0; i < crsaPages.length; i++) {
            if (crsaPages[i] != this && crsaPages[i].live_update == this) {
                r.push(crsaPages[i])
            }
        }
        return r
    };
    this.elementWasSelected = function ($el) {
        if (!this.scrollMode)return;
        var start_ms = (new Date).getTime();
        var pages = this.getMirroredPages();
        if (this.live_update)pages.push(this.live_update);
        if (pages.length > 0) {
            var all = this.$iframe.get(0).contentDocument.querySelectorAll("*");
            if (all) {
                var idx = -1;
                var elnode = $el.get(0);
                for (var n = 0; n < all.length; n++) {
                    if (all[n] == elnode) {
                        idx = n;
                        break
                    }
                }
                if (idx >= 0) {
                    for (var i = 0; i < pages.length; i++) {
                        var cp = pages[i];
                        var cp_all = cp.$iframe.get(0).contentDocument.querySelectorAll("*");
                        if (cp_all && cp_all.length > idx) {
                            var $cpel = $(cp_all[idx]);
                            scrollToElementInIframe($cpel, cp.$iframe)
                        }
                    }
                }
            }
        }
        var elapsed_ms = (new Date).getTime() - start_ms
    };
    this.pageLoaded = function () {
        var pages = this.getMirroredPages();
        for (var i = 0; i < pages.length; i++) {
            var cp = pages[i];
            if (cp.url != this.url) {
                cp.rename(this.url);
                cp.reload()
            }
        }
    };
    this.hasCssChanges = function () {
        if (this.force_close)return false;
        var ps = getCrsaPageStylesForPage(this.$iframe);
        var has = false;
        if (ps) {
            $.each(ps.stylesheets, function (i, cs) {
                if (cs.inline)return true;
                if (!cs.loaded)return true;
                has = has || cs.changed
            })
        }
        return has
    };
    this.hasChanges = function () {
        return this.changed || this.hasCssChanges()
    };
    this.getBreakpointsFromCss = function (done) {
        var ps = getCrsaPageStylesForPage(this.$iframe);
        var has = false;
        var r = [];
        var doDone = function () {
            var list = [];
            for (var i = 0; i < r.length; i++) {
                if (r.indexOf(r[i] + 1) >= 0) {
                    r[i] = -1
                }
            }
            for (var i = 0; i < r.length; i++) {
                if (r[i] > 0 && list.indexOf(r[i]) < 0) {
                    list.push(r[i])
                }
            }
            done(list)
        };
        if (ps) {
            var c = 0;
            $.each(ps.stylesheets, function (i, cs) {
                c++;
                if (!cs.loaded) {
                    cs.ignore = false;
                    cs.load(cs.url, function () {
                        r = r.concat(cs.getBreakpoints());
                        cs.ignore = true;
                        c--;
                        if (c == 0)doDone()
                    })
                } else {
                    setTimeout(function () {
                        r = r.concat(cs.getBreakpoints());
                        c--;
                        if (c == 0)doDone()
                    }, 100)
                }
            });
            if (c == 0)doDone()
        } else {
            doDone()
        }
    };
    this.changeBreakpoint = function (old, b, done) {
        if (old == b)return;
        for (var i = 0; i < this.breakpoints.length; i++) {
            if (b == this.breakpoints[i]) {
                throw"Breakpoint " + b + " is already set."
            }
        }
        for (var i = 0; i < this.breakpoints.length; i++) {
            if (old == this.breakpoints[i]) {
                this.breakpoints[i] = b
            }
        }
        this.setPageChanged(true);
        describeMediaQueryCache = {};
        var ps = getCrsaPageStylesForPage(this.$iframe);
        var has = false;
        var r = [];
        var changed = false;
        var doDone = function () {
            done(changed)
        };
        if (ps) {
            var c = 0;
            $.each(ps.stylesheets, function (i, cs) {
                c++;
                if (!cs.loaded) {
                    cs.ignore = false;
                    cs.load(cs.url, function () {
                        cs.changeBreakpoint(old, b, function (ch) {
                            c--;
                            changed = changed || ch;
                            _this.setPageChanged(true);
                            cs.ignore = !ch;
                            if (c == 0)doDone()
                        })
                    })
                } else {
                    setTimeout(function () {
                        cs.changeBreakpoint(old, b, function (ch) {
                            c--;
                            changed = changed || ch;
                            _this.setPageChanged(true);
                            if (c == 0)doDone()
                        })
                    }, 40)
                }
            });
            if (c == 0)doDone()
        } else {
            doDone()
        }
    };
    this.addBreakpoint = function (b) {
        b = parseInt(b);
        for (var i = 0; i < this.breakpoints.length; i++) {
            if (b == this.breakpoints[i]) {
                throw"Breakpoint " + b + " is already set."
            }
        }
        this.breakpoints.push(b);
        this.breakpoints.sort(function (a, b) {
            return a - b
        });
        this.setPageChanged(true);
        describeMediaQueryCache = {}
    };
    this.removeBreakpoint = function (b) {
        var r = [];
        for (var i = 0; i < this.breakpoints.length; i++) {
            if (b != this.breakpoints[i]) {
                r.push(this.breakpoints[i])
            }
        }
        this.breakpoints = r;
        this.setPageChanged(true);
        describeMediaQueryCache = {}
    };
    this.setAllBreakpoints = function (list) {
        this.breakpoints = list;
        this.breakpoints.sort(function (a, b) {
            return a - b
        });
        describeMediaQueryCache = {}
    };
    this.showManageBreakpoints = function () {
        var showEditBox = function ($el, old) {
            var eid = getUniqueId();
            if ($el.data("popover-active")) {
                $el.popover("destroy");
                $el.data("popover-active", null);
                return
            }
            var ensureRemove = function ($e) {
                setTimeout(function () {
                    $e.closest(".popover").remove()
                }, 750)
            };
            var pop = $el.popover({
                html: true,
                placement: "right",
                trigger: "manual",
                title: old ? "Edit breakpoint" : "Add new breakpoint",
                container: "body",
                content: '<form id="' + eid + '"><form><input class="form-control" placeholder="width in px" style="margin-bottom:8px;"/><button class="ok btn">' + (old ? "Set" : "Add") + '</button><button class="closeit btn btn-link">Cancel</button></form>'
            }).on("shown.bs.popover", function () {
                var $d = $("#" + eid);
                var $i = $d.find("input").focus();
                var $b = $d.find("button.ok");
                var $bc = $d.find("button.closeit");
                if (old) {
                    $i.val(old)
                }
                var doAdd = function () {
                    var val = $.trim($i.val());
                    if (val.length > 0) {
                        val = val.replace(/[^0-9]/g, "");
                        try {
                            if (!old) {
                                _this.addBreakpoint(val)
                            } else {
                                if ($el) {
                                    $el.html("Please wait...").addClass("disabled")
                                }
                                _this.undoStack.add("Change breakpoint");
                                _this.changeBreakpoint(old, val, function (changed) {
                                    $el.html("Edit").removeClass("disabled");
                                    if (changed) {
                                        setTimeout(function () {
                                            crsaQuickMessage("Stylesheets were updated!", 3e3)
                                        }, 250);
                                        setTimeout(function () {
                                            $("body").trigger("crsa-stylesheets-changed")
                                        }, 50)
                                    }
                                })
                            }
                            didMakeChange(_this.$iframe);
                            $el.popover("hide");
                            ensureRemove($d);
                            updateList();
                            $("body").trigger("crsa-breakpoints-changed")
                        } catch (err) {
                            alert(err)
                        }
                    }
                };
                $b.on("click", function (e) {
                    e.preventDefault();
                    doAdd()
                });
                $d.on("submit", function (e) {
                    e.preventDefault();
                    doAdd()
                });
                $bc.on("click", function (e) {
                    $el.popover("hide");
                    e.preventDefault();
                    ensureRemove($d)
                })
            }).on("hidden.bs.popover", function () {
                setTimeout(function () {
                    $el.popover("destroy").data("popover-active", null)
                }, 10)
            });
            $el.popover("show").data("popover-active", true)
        };
        var $ul = $("<ul/>");
        var updateList = function () {
            $ul.html("");
            for (var i = 0; i < _this.breakpoints.length; i++) {
                var $button = $('<a href="#" class="btn btn-sm btn-link">Edit</a>');
                var $del = $('<a href="#" class="btn btn-sm btn-link">Delete</a>');
                $("<li></li>").html(_this.breakpoints[i] + "px").appendTo($ul).append($button).append($del).data("breakpoint", _this.breakpoints[i]);
                $button.on("click", function (e) {
                    var $li = $(e.delegateTarget).closest("li");
                    e.preventDefault();
                    showEditBox($(e.delegateTarget), $li.data("breakpoint"))
                });
                $del.on("click", function (e) {
                    var $li = $(e.delegateTarget).closest("li");
                    e.preventDefault();
                    if (confirm("Are you sure? Existing CSS rules will not be affected.")) {
                        _this.removeBreakpoint($li.data("breakpoint"));
                        updateList();
                        $("body").trigger("crsa-breakpoints-changed");
                        didMakeChange(_this.$iframe)
                    }
                })
            }
        };
        updateList();
        var $b = $ul;
        var $main = $('<div class="manager"><p>Note: At the moment only breakpoints in <b>px</b> unit are supported.</p></div>').append($b);
        var msg = "";
        $('<a href="#" class="btn btn-link add">Add breakpoint...</a>').appendTo($main).on("click", function (e) {
            e.preventDefault();
            showEditBox($(this))
        });
        $('<a href="#" class="btn btn-link add">Get from stylesheets</a>').appendTo($main).on("click", function (e) {
            e.preventDefault();
            var $b = $(e.delegateTarget);
            $b.html("Please wait...").addClass("disabled");
            _this.getBreakpointsFromCss(function (list) {
                if (list.length) {
                    var dofunc = function () {
                        _this.setAllBreakpoints(list);
                        didMakeChange(_this.$iframe);
                        crsaQuickMessage("Done!", 2e3)
                    };
                    if (_this.breakpoints.length) {
                        var msg = "Breakpoints [" + list.join(", ") + "] were found in CSS. Do you want to use them instead of current breakpoints? This can't be undone.";
                        if (confirm(msg)) {
                            dofunc()
                        }
                    } else {
                        dofunc()
                    }
                } else {
                    crsaQuickMessage("No breakpoints found!", 2e3)
                }
                updateList();
                $("body").trigger("crsa-breakpoints-changed");
                $b.html("Get from stylesheets").removeClass("disabled")
            })
        });
        $('<a href="http://docs.pinegrow.com/solution/articles/1000067353-creating-responsive" target="_blank" class="btn btn-link add external">Help</a>').appendTo($main);
        crsaHandleExternalLinks($main);
        var updateMetaAdd = function () {
            var $ma = $main.find(".meta-add");
            if (!$ma.length) {
                $ma = $('<div class="meta-add well" style="margin-top:12px;"></div>').appendTo($main)
            }
            var $head = _this.get$Html().find("head");
            var $m = $head.find('meta[name="viewport"]');
            if ($m.length) {
                $ma.hide()
            } else {
                $ma.html('<p>Document needs <code>&lt;meta name=&quot;viewport&quot; ... &gt;</code> directive to enable responsive behaviour on mobile devices. <a href="#" class="">Add it!</a></p>');
                var $add = $ma.find("a");
                $ma.show();
                $add.on("click", function (e) {
                    e.preventDefault();
                    _this.undoStack.add("Meta viewport directive added");
                    $head.append('<meta name="viewport" content="width=device-width, initial-scale=1.0">');
                    _this.setPageChanged(true);
                    didMakeChange(_this.$iframe, $head);
                    updateMetaAdd();
                    crsaQuickMessage("Viewport declaration added!", 2e3)
                })
            }
        };
        updateMetaAdd();
        var $d = makeModalDialog("Manage breakpoints", "Close", null, $main);
        $d.removeAttr("tabindex");
        $d.find(".modal-dialog").css("width", "500px")
    };
    var describeMediaQueryCache = {};
    this.describeMediaQuery = function (q) {
        var rule = null;
        if (q in describeMediaQueryCache) {
            return describeMediaQueryCache[q]
        }
        var idx = q.indexOf("(");
        if (idx >= 0) {
            rule = q.substr(idx);
            if (q.indexOf("only") >= 0) {
                rule = rule.replace("only ", "")
            }
            $.each(["screen", "print"], function (i, t) {
                if (q.indexOf(t) >= 0) {
                    type = t;
                    rule = rule.replace(t, "")
                }
            })
        } else {
            rule = q
        }
        rule = rule.replace(/\s/g, "");
        var res = null;
        if (_this.breakpoints.length) {
            for (var i = 0; i < _this.breakpoints.length; i++) {
                var x = _this.breakpoints[i];
                var mq = "(max-width:" + (x - 1) + "px)";
                if (rule == mq) {
                    res = '<span class="line"></span><span class="excluding">' + x + "</span>";
                    break
                }
                mq = "(min-width:" + x + "px)";
                if (rule == mq) {
                    res = '<span class="including">' + x + '</span><span class="line"></span>';
                    break
                }
                if (i < _this.breakpoints.length - 1) {
                    var nx = _this.breakpoints[i + 1];
                    mq = "(min-width:" + x + "px)and(max-width:" + (nx - 1) + "px)";
                    if (rule == mq) {
                        res = '<span class="including">' + x + '</span><span class="line"></span><span class="excluding">' + nx + "</span>";
                        break
                    }
                }
            }
        }
        describeMediaQueryCache[q] = res ? res : q;
        return res ? res : q
    };
    this.showMediaQueryHelper = function ($el) {
        var offset = $el.offset();
        var place = offset.left > $(window).width() / 2 ? "left" : "right";
        var eid = getUniqueId();
        if ($el.data("tool-active")) {
            $el.data("tool-active", null);
            return
        }
        var ensureRemove = function ($e) {
            $dialog.hide();
            $el.data("tool-active", null);
            tool.closed = true;
            setTimeout(function () {
                $dialog.remove()
            }, 500)
        };
        var original = $.trim($el.val());
        var original_just_rule = "";
        var has_only = localStorage.mediaToolOnly ? true : false;
        var type = localStorage.mediaToolType ? localStorage.mediaToolType : null;
        var strange = true;
        if (original) {
            var idx = original.indexOf("(");
            if (idx >= 0) {
                original_just_rule = original.substr(idx);
                if (original.indexOf("only") >= 0) {
                    has_only = true;
                    original_just_rule = original_just_rule.replace("only ", "")
                }
                $.each(["screen", "print"], function (i, t) {
                    if (original.indexOf(t) >= 0) {
                        type = t;
                        original_just_rule = original_just_rule.replace(t, "")
                    }
                });
                original_just_rule = original_just_rule.replace(/\s\s+/g, " ");
                strange = false
            } else {
                original_just_rule = original
            }
        } else {
            strange = false
        }
        var done = false;
        var s = "";
        if (_this.breakpoints.length) {
            for (var i = 0; i < _this.breakpoints.length; i++) {
                var x = _this.breakpoints[i];
                var mq = "(max-width:" + (x - 1) + "px)";
                s += '<li class="media-query" data-media="' + mq + '"><i class="fa fa-check"></i><span class="line"></span><span class="excluding">' + x + "</span><small>smaller than " + x + " px</small></li>";
                mq = "(min-width:" + x + "px)";
                s += '<li class="media-query" data-media="' + mq + '"><i class="fa fa-check"></i><span class="including">' + x + '</span><span class="line"></span><small>' + x + " px and up</small></li>";
                if (i < _this.breakpoints.length - 1) {
                    var nx = _this.breakpoints[i + 1];
                    mq = "(min-width:" + x + "px) and (max-width:" + (nx - 1) + "px)";
                    s += '<li class="media-query submedia-last" data-media="' + mq + '"><i class="fa fa-check"></i><span class="including">' + x + '</span><span class="line"></span><span class="excluding">' + nx + "</span><small>from " + x + " px to " + (nx - 1) + " px</small></li>"
                }
            }
        } else {
            s += "<li>No breakpoints are defined. Use &quot;Manage breakpoints&quot; to define them.</li>"
        }
        var triggerTimeout = null;
        var triggerChange = function ($el) {
            if (triggerTimeout) {
                clearTimeout(triggerTimeout)
            }
            triggerTimeout = setTimeout(function () {
                $el.trigger("change");
                triggerTimeout = null
            }, 50)
        };
        var form = '<form role="form" class="form-inline">            <div class="form-group" style="margin-right:10px;">            <label class="control-label sr-only" for="formInput1">Field label</label>            <select id="formInput1" class="form-control input-sm">            <option></option>            <option>screen</option>            <option>print</option>        </select>        </div>            <div class="checkbox">                <label class="control-label">                    <input type="checkbox"> Ignore in old browsers</label>                </div>            </form>';
        var $c = $('<div id="' + eid + '" class="media-tool"><ul class="media-list">' + s + "</ul>" + form + "</div>");
        var $body = $("body");
        var $dialog = makeDialog("Select media query", "Cancel", "Ok", $c).css("width", "400px");
        $body.append($dialog);
        $dialog.find(".modal-footer").prepend('<a href="#" class="pull-left manage btn btn-link">Manage breakpoints...</a>').css("margin-top", "0px");
        $dialog.find(".modal-body").css("padding-bottom", "0px");
        $dialog.on("keydown", function (e) {
            if (e.which == 27) {
                $dialog.find("button.cancel").trigger("click");
                e.preventDefault()
            }
        });
        var elo = $el.offset();
        var bw = $body.width();
        var bh = $body.height();
        var x, y;
        if (elo.left < bw / 2) {
            x = elo.left + $el.width() + 35
        } else {
            x = elo.left - $dialog.width() - 10
        }
        y = elo.top - $dialog.height() / 2;
        x = localStorage.mediaToolX ? parseInt(localStorage.mediaToolX) : x;
        y = localStorage.mediaToolY ? parseInt(localStorage.mediaToolY) : y;
        if (y < 10)y = 10;
        if (y + $dialog.height() > bh) {
            y = bh - 10 - $dialog.height()
        }
        if (x < 10)x = 10;
        if (x + $dialog.width() > bw) {
            x = bw - 10 - $dialog.width()
        }
        $dialog.css("top", y + "px").css("left", x + "px");
        $dialog.draggable({handle: ".modal-header"}).on("dragstart", function () {
            $.fn.crsapages("showOverlays")
        }).on("dragstop", function () {
            $.fn.crsapages("showOverlays", true);
            var ofs = $dialog.offset();
            localStorage.mediaToolX = ofs.left;
            localStorage.mediaToolY = ofs.top
        });
        var $d = $("#" + eid);
        var $ul = $d.find("ul");
        var $b = $dialog.find("button.ok");
        var $bc = $dialog.find("button.close,button.cancel");
        var $select = $d.find("select");
        var $only = $d.find('input[type="checkbox"]');
        if (strange) {
            $select.attr("disabled", "disabled");
            $only.attr("disabled", "disabled")
        } else {
            $select.val(type);
            if (has_only) {
                $only.attr("checked", "checked")
            }
            $select.on("change", function (e) {
                apply(original_just_rule);
                localStorage.mediaToolType = $select.val()
            });
            $only.on("change", function (e) {
                apply(original_just_rule);
                localStorage.mediaToolOnly = $only.is(":checked") ? "1" : "0"
            })
        }
        var apply = function (q) {
            var s = $select.val();
            var has_and = false;
            if (s) {
                if (q.length) {
                    q = s + " and " + q;
                    has_and = true
                } else {
                    q = s
                }
            }
            if ($only.is(":checked")) {
                q = "only " + (!has_and ? "" : "") + q
            }
            $el.val(q);
            triggerChange($el)
        };
        var current = original_just_rule.replace(/\s/g, "");
        $ul.find("li").each(function (i, e) {
            var $li = $(e);
            var q = $li.attr("data-media");
            if (q) {
                if (q.replace(/\s/g, "") == current) {
                    $li.addClass("media-current")
                }
                var win = _this.getWindow();
                if (win && win.matchMedia(q).matches) {
                    $li.addClass("media-match")
                }
            }
        });
        $ul.find("i.fa-check:visible").tooltip({
            container: "body",
            title: "Matches current window size (" + _this.deviceWidth + "px)."
        });
        $ul.find("li").on("mouseover", function (e) {
            if (!done) {
                var $e = $(e.delegateTarget);
                var q = $e.attr("data-media");
                if (q) {
                    apply(q)
                }
            }
        }).on("mouseout", function (e) {
            if (!done) {
                var q = $(e.delegateTarget).attr("data-media");
                if (q) {
                    if (strange) {
                        $el.val(original);
                        triggerChange($el)
                    } else {
                        apply(original_just_rule)
                    }
                }
            }
        }).on("click", function (e) {
            done = true;
            e.preventDefault();
            var $e = $(e.delegateTarget);
            var q = $e.attr("data-media");
            if (q) {
                $ul.find("li.media-current").removeClass("media-current");
                $e.addClass("media-current");
                apply(q);
                ensureRemove($d)
            }
        });
        $b.on("click", function (e) {
            e.preventDefault();
            done = true;
            ensureRemove($d)
        });
        $bc.on("click", function (e) {
            done = true;
            $el.val(original);
            triggerChange($el);
            e.preventDefault();
            ensureRemove($d)
        });
        $dialog.find(".manage").on("click", function (e) {
            done = true;
            $el.val(original);
            triggerChange($el);
            e.preventDefault();
            ensureRemove($d);
            _this.showManageBreakpoints()
        });
        $el.data("tool-active", true);
        var tool = {
            closed: false, close: function () {
                ensureRemove()
            }
        };
        return tool
    };
    this.getPageInfo = function () {
        if (!_this.localFile || !isApp())return null;
        var fs = require("fs");
        var pgfile = crsaGetFileDir(_this.localFile) + "pinegrow.json";
        var info = {files: {}};
        try {
            var json = fs.readFileSync(pgfile, {encoding: "utf8"});
            info = JSON.parse(json);
            return info.files && info.files[_this.name] ? info.files[_this.name] : null
        } catch (err) {
        }
    };
    this.getProjectInfo = function () {
        if (!_this.localFile || !isApp())return null;
        var fs = require("fs");
        var pgfile = crsaGetFileDir(_this.localFile) + "pinegrow.json";
        var info = {files: {}};
        try {
            var json = fs.readFileSync(pgfile, {encoding: "utf8"});
            info = JSON.parse(json);
            return info
        } catch (err) {
        }
    };
    this.getDocument = function () {
        return this.$iframe.get(0).contentDocument
    };
    this.getWindow = function () {
        return this.$iframe.get(0).contentWindow
    };
    this.getBody = function () {
        return getIframeBody(this.$iframe.get(0))
    };
    this.get$Html = function () {
        var doc = this.getDocument();
        return $(doc).find("> html")
    };
    this.getElementWithPgId = function (pgid) {
        var $el = this.get$Html().find('[data-pg-id="' + pgid + '"]');
        return $el.length ? $el : null
    };
    this.getElementFromPgParserNode = function (pgel) {
        return this.getElementWithPgId(pgel.getId())
    };
    this.getData = function ($el, key) {
        try {
            var id = getUniqueId("crsa");
            $el.attr("data-tmp", id);
            var windowjQuery = this.$iframe[0].contentWindow.$;
            var f = this.$iframe.contents().find('[data-tmp="' + id + '"]');
            $el.removeAttr("data-tmp");
            return f.length > 0 ? windowjQuery.data(f.get(0), key) : null
        } catch (err) {
        }
        return null
    };
    this.save = function (done, save_html, save_css, save_as, save_project, first_save) {
        if (isApp()) {
            if (typeof save_project == "undefined")save_project = true;
            var proxyUrl = pinegrow.httpServer.url + "/";
            var proxyRe = new RegExp(escapeRegExp(proxyUrl), "g");
            var html = this.sourceNode.toStringOriginal(true, pinegrow.getFormatHtmlOptions(), function (node, str, type) {
                if (type == "attrs") {
                    str = str.replace(proxyRe, "")
                }
                return str
            });
            var fs = require("fs");
            var pm = require("path");
            if (this.localFile && !save_as) {
                try {
                    if (this.live_update && this.save_parent) {
                        if (done)done();
                        showAlert("The page was not saved because it is a mirrored page. You should save the parent page " + this.live_update.name + " instead.", "Page was not saved");
                        return
                    }
                    var dir = crsaGetFileDir(this.localFile);
                    if (this.crsaProjectTemplate && save_project) {
                        this.crsaProjectTemplate.copyRequiredFilesTo(dir)
                    }
                    var notice = [];
                    var saveDone = function (err, saved_csss) {
                        var url = crsaMakeUrlFromFile(_this.localFile);
                        if (url != _this.url && crsaIsFileUrl(_this.url))_this.rename(url);
                        if (done)done(err);
                        _this.callFrameworkHandler("on_page_saved", saved_csss);
                        var b = "";
                        if (!isFile && first_save) {
                            b += isFile ? "</ul>" : "</ul><p>Images, scripts and other resources were not saved.</p><p>If you want to save all changes it is recommended to first save the whole webpage to your computer (Save As Complete page in your browser) and then open it in Pinegrow.</p>"
                        }
                        if (notice.length > 0) {
                            b += isFile ? "<p>The following stylesheets were not saved because they have syntax errors or are located on remote servers:</p><ul>" : "<p>The following stylesheets were not saved because they have syntax errors or their paths would place them outside of the folder selected for saving the HTML file:</p><ul>";
                            for (var i = 0; i < notice.length; i++) {
                                b += "<li>" + notice[i].url + " - " + (notice[i].error == "syntax" ? "Syntax error (check CSS panel for more)" : "Invalid url") + "</li>"
                            }
                        }
                        if (b.length > 0) {
                            showAlert(b, "Some files were not saved")
                        } else {
                            crsaQuickMessage(save_css ? _this.name + " was saved." : _this.name + " (HTML only) was saved.")
                        }
                    };
                    var isFile = crsaIsFileUrl(this.url);
                    if (save_html) {
                        this.lastSavedAt = (new Date).getTime();
                        crsaWriteFileWithBackup(fs, this.localFile, html, "utf8");
                        this.setPageChanged(false);
                        var $body = $(getIframeBody(this.$iframe.get(0)));
                        var $components = $body.find("[data-pg-component]").each(function (i, c) {
                            var $c = $(c);
                            var name = $c.data("pg-component");
                            if (name) {
                                var html = $c.get(0).outerHTML;
                                html = removeCrsaClassesFromHtml(html);
                                html = html_beautify(html);
                                var file = crsaGetFileDir(_this.localFile) + "components" + pm.sep + name + ".html";
                                crsaWriteFileWithBackup(fs, file, html, "utf8")
                            }
                        });
                        var pgfile = crsaGetFileDir(_this.localFile) + "pinegrow.json";
                        var info = {files: {}};
                        try {
                            var json = fs.readFileSync(pgfile, {encoding: "utf8"});
                            info = JSON.parse(json)
                        } catch (err) {
                        }
                        if (!("files"in info)) {
                            info.files = {}
                        }
                        var pageinfo = {frameworks: []};
                        for (var i = 0; i < _this.frameworks.length; i++) {
                            pageinfo.frameworks.push(_this.frameworks[i].key)
                        }
                        info.files[_this.name] = pageinfo;
                        info.breakpoints = _this.breakpoints;
                        var json = JSON.stringify(info);
                        crsaWriteFileWithBackup(fs, pgfile, json, "utf8")
                    }
                    if (save_css) {
                        var saved_csss = [];
                        var cp = getCrsaPageStylesForPage(this.$iframe);
                        var count = 0;
                        $.each(cp.getAllCrsaStylesheets(), function (i, cs) {
                            if (cs.inline)return true;
                            if (!cs.loaded)return true;
                            var rel_url = crsaMakeLinkRelativeTo(cs.url, crsaMakeUrlAbsolute(_this.url));
                            rel_url = crsaRemoveUrlParameters(rel_url);
                            var path;
                            if (cs.genGetError()) {
                                notice.push({url: cs.url, error: "syntax"})
                            } else {
                                if (rel_url.indexOf("://") >= 0 && !crsaIsFileUrl(rel_url) || !isFile && rel_url.indexOf("..") >= 0) {
                                    if (cs.changed) {
                                        notice.push({url: cs.url, error: "url"})
                                    }
                                } else {
                                    if (rel_url.indexOf("://") >= 0) {
                                        path = crsaMakeFileFromUrl(rel_url)
                                    } else {
                                        path = dir + rel_url
                                    }
                                    count++;
                                    cs.save(path, function (err) {
                                        if (err)throw err;
                                        count--;
                                        saved_csss.push({cs: cs, path: path});
                                        if (count == 0)saveDone(null, saved_csss)
                                    }, fs, function (source) {
                                        return source;
                                        return source.replace(proxyRe, "")
                                    })
                                }
                            }
                        });
                        if (count == 0)saveDone()
                    } else {
                        saveDone()
                    }
                } catch (err) {
                    if (done)done(err);
                    showAlert("Could not save file: " + err.message, "Error")
                }
            } else {
                crsaChooseFile(function (url, file) {
                    var dofunc = function () {
                        var origLocalFile = _this.localFile;
                        var origSaveParent = _this.save_parent;
                        _this.setLocalFile(file);
                        _this.save_parent = false;
                        _this.save(function (err) {
                            if (!err) {
                                if (crsaIsFileUrl(_this.url)) {
                                    _this.rename(url);
                                    _this.reload()
                                }
                            } else {
                                _this.setLocalFile(_this.localFile);
                                _this.save_parent = origSaveParent
                            }
                            done()
                        }, save_html, save_css, false, true, true)
                    };
                    if (url.indexOf(".htm") < 0) {
                        showAlert("Do you want to use the file without the <b>.html</b> extension? Some browsers will not recognize it.", "No .html extension", "Use as is", "Add .html extension", function () {
                            dofunc()
                        }, function () {
                            file = file + ".html";
                            url = url + ".html";
                            dofunc()
                        })
                    } else {
                        dofunc()
                    }
                }, this.name)
            }
        } else {
            var store = new CrsaBrowserStorage;
            if (save_html) {
                store.save(this.url, html);
                this.setPageChanged(false)
            }
            if (save_css) {
                var cp = getCrsaPageStylesForPage(this.$iframe);
                var count = 0;
                $.each(cp.getAllCrsaStylesheets(), function (i, cs) {
                    if (cs.inline)return true;
                    var less = cs.getLessSource();
                    store.save(cs.url, less);
                    cs.changed = false
                })
            }
            if (done)done()
        }
    };
    this.saveChangedFrameworks = function (done) {
        for (var i = 0; i < this.frameworks.length; i++) {
            var f = this.frameworks[i];
            (function (f) {
                if (f.user_lib && f.changed) {
                    if (f.localFile) {
                        f.save(f.localFile, function () {
                            crsaQuickMessage("Library " + f.name + " saved.");
                            pinegrow.frameworksChanged();
                            if (done)done()
                        })
                    } else {
                        crsaChooseFile(function (url, file) {
                            f.save(file, function () {
                                crsaQuickMessage("Library " + f.name + " saved.");
                                pinegrow.frameworksChanged();
                                if (done)done()
                            })
                        }, f.getFileName())
                    }
                }
            })(f)
        }
    };
    this.rename = function (new_url) {
        this.url = new_url;
        this.name = getPageName(new_url);
        this.updateNameDisplay()
    };
    this.updateNameDisplay = function () {
        this.$page.find(".name").html(this.name);
        this.$page.find("a.crsa-preview").attr("href", this.url)
    };
    this.duplicate = function () {
        var cp = new CrsaPage;
        cp.url = this.url;
        cp.scrollMode = this.scrollMode;
        cp.frameworks = this.frameworks.slice(0);
        cp.breakpoints = this.breakpoints.slice(0);
        var skip = [];
        for (var j = 0; j < crsaPages.length; j++) {
            skip.push(crsaPages[j].name)
        }
        cp.name = crsaDuplicateName(this.name, this.localFile, skip);
        if (this.localFile) {
            cp.setLocalFile(crsaGetFileDir(this.localFile) + cp.name)
        }
        return cp
    };
    this.loadingStart = function (onCancel) {
        $.fn.crsapages("showLoadingOverlay", this.$page, false, function () {
            if (onCancel)onCancel(_this)
        })
    };
    this.loadingDone = function () {
        $.fn.crsapages("showLoadingOverlay", this.$page, true)
    };
    this.reload = function () {
        $(".canvas").trigger("crsa-page-reload", this)
    };
    this.refresh = function () {
        $(".canvas").trigger("crsa-page-refresh", this)
    };
    this.autoSize = function () {
        $.fn.crsapages("autoSizePage", this.$iframe, this.scrollMode)
    };
    this.setLiveUpdate = function (crsaPage) {
        var $body = $("body");
        if (!crsaPage) {
            if (this.live_update) {
            }
            this.$page.removeClass("mirrored");
            this.live_update = null
        } else {
            this.$page.addClass("mirrored");
            var source = crsaPage.live_update ? crsaPage.live_update : crsaPage;
            this.live_update = source
        }
    };
    this.callFrameworkHandler = function (name, a, b, c) {
        var ret = null;
        for (var i = 0; i < _this.frameworks.length; i++) {
            var f = _this.frameworks[i];
            if (name in f && f[name]) {
                ret = f[name](_this, a, b, c)
            }
        }
        return ret
    };
    this.callGlobalFrameworkHandler = function (name, a, b, c) {
        return pinegrow.callGlobalFrameworkHandler(name, a, b, c, this)
    };
    this.getSource = function (full_source, skip_beautify) {
        var addHtml = function (src) {
            var h = "<html";
            $.each(getIframeHtmlElement(_this.$iframe.get(0)).attributes, function (idx, attr) {
                h += " " + attr.nodeName + '="' + attr.nodeValue + '"'
            });
            h += ">";
            return "<!DOCTYPE html>\n" + h + "\n" + src + "\n</html>"
        };
        var str;
        if (this.sourceNode) {
            str = this.sourceNode.toStringOriginal(true, pinegrow.getFormatHtmlOptions());
            if (!skip_beautify) {
            }
        } else {
            this.doWithoutCrsaStyles(function () {
                var doc = _this.getDocument();
                var $html = $(doc).find("> html").clone(true);
                _this.callFrameworkHandler("on_get_source", $html);
                str = $html.length > 0 ? $html[0].innerHTML : "";
                str = str.replace(/(<[^>]*)\s*contenteditable="true"/gi, "$1");
                str = str.replace(/(<[^>]*)\s*style=""/gi, "$1");
                str = removeCrsaClassesFromHtml(str)
            });
            if (full_source) {
                str = addHtml(str);
                if (!skip_beautify) {
                    str = html_beautify(str)
                }
                return this.template.getTemplateSource(str)
            }
        }
        return str
    };
    this.applyChangesToSource = function (html_or_node, abort_on_errors, skip_was_changed, update_stylesheets) {
        var ret = {changes: null, errors: null, updated: false, stylesheets_changed: false, scripts_changed: false};
        var rootNode;
        var clone = false;
        if (typeof html_or_node == "string") {
            var parser = new pgParser;
            parser.assignIds = false;
            parser.parse(html_or_node);
            rootNode = parser.rootNode
        } else {
            rootNode = html_or_node;
            clone = true
        }
        ret.errors = rootNode.validateTree();
        if (ret.errors.length && abort_on_errors) {
            console.log("ERRORS");
            console.log(ret.errors);
            return ret
        }
        var changes = pgFindChangedNodesInPage(this.sourceNode, rootNode);
        ret.changes = changes;
        var $update_els = $([]);
        var done = false;
        var stylesheets_changed = false;
        var css_tags = ["style", "html", "head"];
        if (changes.length) {
            pinegrow.httpServer.setCurrentRequestContext(this.url, rootNode);
            var whole = false;
            for (var i = 0; i < changes.length; i++) {
                var ch = changes[i];
                if (ch.original.parent == null) {
                    whole = true;
                    break
                }
            }
            if (!whole) {
                for (var i = 0; i < changes.length; i++) {
                    var ch = changes[i];
                    var pgid = ch.original.getId();
                    var $el = this.getElementWithPgId(pgid);
                    if (clone) {
                        ch.changed = ch.changed.clone(true)
                    }
                    ch.changed.assignIdAndAddToCatalog(true);
                    ch.original.replaceWith(ch.changed);
                    if (css_tags.indexOf(ch.original.tagName) >= 0 || css_tags.indexOf(ch.changed.tagName) >= 0 || ch.original.tagName == "link" && ch.original.getAttr("rel") == "stylesheet" || ch.changed.tagName == "link" && ch.changed.getAttr("rel") == "stylesheet") {
                        stylesheets_changed = true
                    }
                    if (ch.original.tagName == "script" || ch.changed.tagName == "script") {
                        ret.scripts_changed = true
                    }
                    if ($el) {
                        var tree_id = $el.attr("data-pg-tree-id");
                        var str = ch.changed.toStringWithIds(true, null, pinegrow.httpServer.createProxyUrlNodeOutputFilter);
                        $el.get(0).outerHTML = str;
                        var $el = this.getElementWithPgId(ch.changed.getId());
                        if (!$el) {
                        }
                        if (tree_id && $el) {
                            $el.attr("data-pg-tree-id", tree_id);
                            $update_els = $update_els.add($el.get(0))
                        }
                    } else {
                    }
                    done = true
                }
            }
            if (done) {
                if ($update_els.length && this == pinegrow.getSelectedPage()) {
                    $.fn.crsa("updateStructureAndWireAllElemets", this.$iframe, $update_els, true)
                }
                if (stylesheets_changed && update_stylesheets) {
                    _this.updateStylesheetsList()
                }
                this.setPageChanged(true);
                if (!skip_was_changed) {
                    didMakeChange(this.$iframe)
                }
                ret.updated = true;
                ret.stylesheets_changed = stylesheets_changed;
                return ret
            }
        } else {
            console.log("no changes");
            ret.updated = true;
            return ret
        }
        this.sourceNode.remove();
        this.sourceNode = clone ? parser.rootNode.clone(true) : parser.rootNode;
        this.sourceNode.assignIdAndAddToCatalog(true);
        console.log("whole document is changed.");
        return ret
    };
    this.setSource = function (html, done, no_init, skip_dom_update) {
        var parser = new pgParser;
        parser.parse(html, function () {
            _this.sourceNode = parser.rootNode;
            var htmlNodes = parser.rootNode.find(">html");
            if (htmlNodes && htmlNodes.length) {
                var htmlCode = htmlNodes[0].html(null, true);
                var doc = getIframeDocument(_this.$iframe.get(0));
                var $html = $(doc).find("> html");
                $html[0].innerHTML = htmlCode;
                var attributes = $.map($html[0].attributes, function (item) {
                    return item.name
                });
                $.each(attributes, function (i, item) {
                    $html.removeAttr(item)
                });
                var attrs = htmlNodes[0].getAttrList();
                for (var i = 0; i < attrs.length; i++) {
                    $html.attr(attrs[i].name, attrs[i].value)
                }
                if (!no_init) {
                    setTimeout(function () {
                        $.fn.crsacss("loadLessStyles", _this.$iframe.get(0), function () {
                            $.fn.crsa("updateStructureAndWireAllElemets", _this.$iframe);
                            $("body").trigger("crsa-stylesheets-changed");
                            _this.addCrsaStyles();
                            if (done)done()
                        })
                    }, 500)
                } else {
                    if (done)done()
                }
            } else {
                if (done)done()
            }
        })
    };
    this.runScripts = function (done) {
        if (done)done();
        return;
        var crsaPage = this;
        setTimeout(function () {
            try {
            } catch (err) {
            }
            var evalInlineScripts = function () {
                var scripts = crsaPage.getDocument().getElementsByTagName("script");
                for (var ix = 0; ix < scripts.length; ix++) {
                    var s = scripts[ix];
                    if (s.text) {
                        var scr = document.createElement("script");
                        scr.async = false;
                        scr.text = s.text;
                        $.each(s.attributes, function (idx, attr) {
                            scr.setAttribute(attr.nodeName, attr.nodeValue)
                        });
                        s.parentNode.replaceChild(scr, s)
                    }
                }
                if (done)done()
            };
            var count = 0;
            var scripts = crsaPage.getDocument().getElementsByTagName("script");
            for (var ix = 0; ix < scripts.length; ix++) {
                var s = scripts[ix];
                if (s.src) {
                    var scr = document.createElement("script");
                    scr.async = false;
                    $(scr).on("load", function (e) {
                        setTimeout(function () {
                            count--;
                            if (count == 0) {
                                evalInlineScripts()
                            }
                        }, 1)
                    });
                    count++;
                    $.each(s.attributes, function (idx, attr) {
                        scr.setAttribute(attr.nodeName, attr.nodeValue)
                    });
                    s.parentNode.replaceChild(scr, s)
                }
            }
            if (count == 0) {
                evalInlineScripts()
            }
        }, 500)
    };
    this.addCrsaStyles = function () {
        var o = {css: '.crsa-highlighted {            box-shadow: 0 0 10px rgba(0, 255, 0, 0.9) !important;        }        .crsa-selected {            box-shadow: 0 0 0px 2px rgba(0, 180, 255, 1) !important;        }        .crsa-edit {            cursor: default;        }        *[contenteditable="true"] {            outline: rgb(255, 215, 0) dotted 4px !important;        }        .crsa-disable-hover {            pointer-events: none;        }        '};
        if (pinegrow.getSetting("show-placeholders", "1") == "1") {
            o.css += ".pg-empty-placeholder {            min-height: 100px;            box-shadow: 0 0 0 1px rgba(0,0,0,0.15);            background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAADklEQVQIW2NgQAXGZHAAGioAza6+Hk0AAAAASUVORK5CYII=);        }        ";
            o.css += "*.pg-no-placeholder:empty {            min-height: inherit;        }        "
        }
        o.css += "        .crsa-placed {            opacity: 0.5 !important;        }        html.crsa-stop-animations * {            -webkit-transition-property: none !important;            transition-property: none !important;            -webkit-transform: none !important;            transform: none !important;            -webkit-animation: none !important;            animation: none !important;        }";
        this.callFrameworkHandler("on_set_inline_style", o);
        var css = '<style id="' + cssid + '">' + o.css + "</style>";
        var $head = $(getIframeHead(this.$iframe.get(0)));
        var $cssel = $head.find("#" + cssid);
        if ($cssel.length == 0) {
            $head.append(css)
        } else {
            $cssel.replaceWith($(css))
        }
    };
    this.stopAnimations = function () {
        var $html = $(getIframeHtmlElement(this.$iframe.get(0)));
        $html.addClass("crsa-stop-animations");
        this.animationsStopped = true
    };
    this.startAnimations = function () {
        var $html = $(getIframeHtmlElement(this.$iframe.get(0)));
        $html.removeClass("crsa-stop-animations");
        this.animationsStopped = false
    };
    this.hasStoppedAnimations = function () {
        var $html = $(getIframeHtmlElement(this.$iframe.get(0)));
        return $html.hasClass("crsa-stop-animations")
    };
    this.doWithoutCrsaStyles = function (func) {
        var $head = $(getIframeHead(this.$iframe.get(0)));
        var $c = $head.find("#" + cssid);
        $c.detach();
        func();
        $head.append($c)
    };
    this.getCompatibleUrl = function (url) {
        if (crsaIsFileUrl(url)) {
            if (pinegrow.sourceParser) {
                url = pinegrow.httpServer.makeUrl(url)
            }
        } else {
            url = pinegrow.httpServer.makeProxyUrl(url)
        }
        return url
    }
};
var getCrsaPageForIframe = function ($iframe) {
    if (!$iframe)return null;
    return $iframe.data("crsa-page")
};
var getPageName = function (url) {
    var n = url.split(/[\\\/]/).pop();
    if (n.length == 0)n = "index.html";
    var a = n.split("?");
    return a.length > 1 ? a[0] : n
};
$.fn.crsapages = function (method) {
    if (methods[method]) {
        return methods[method].apply(this, Array.prototype.slice.call(arguments, 1))
    } else if (typeof method === "object" || !method) {
        return methods.init.apply(this, arguments)
    } else {
        $.error("Method " + method + " does not exist on jQuery.crsacss")
    }
};
var options;
var pages;
var crsaPages = [];
var currentZoom = 1;
var centerLeft = 300;
var centerRight = 300;
var fitZoom = false;
var $body = $("body");
var $empty;
var customPageActions = [];
var methods = {
    init: function (opts) {
        options = $.extend({}, $.fn.crsapages.defaults, opts);
        $empty = $(".empty-canvas");
        updatePagesList(this);
        if (isApp()) {
            var gui = require("nw.gui");
            gui.Window.get().on("document-start", function (frame) {
                if (frame) {
                    var cp = getCrsaPageForIframe($(frame));
                    if (cp) {
                        var win = frame.contentWindow;
                        var s_ajaxListener = new Object;
                        s_ajaxListener.tempOpen = win.XMLHttpRequest.prototype.open;
                        win.XMLHttpRequest.prototype.open = function (a, b, async, user, pass) {
                            console.log("Sync AJAX call to " + b + " changed to async. PG would block otherwise.");
                            s_ajaxListener.tempOpen.call(this, a, b, true, user, pass)
                        };
                        $(frame.contentDocument).on("DOMContentLoaded", function () {
                            $.fn.crsa("buildTree", $(frame))
                        })
                    }
                    $(frame).trigger("frame-document-start")
                }
            });
            gui.Window.get().on("document-end", function (frame) {
            });
            gui.Window.get().on("new-win-policy", function (frame, url, policy) {
                console.log("Win open: " + url);
                policy.ignore()
            })
        }
    }, getAllPages: function () {
        return crsaPages
    }, clearUndoSetFlag: function () {
        $.each(crsaPages, function (i, p) {
            p.undoSetFlag = false
        })
    }, saveAll: function (close_on_save) {
        var savedProjects = [];
        $.each(crsaPages, function (i, cp) {
            cp.saveChangedFrameworks();
            if (cp.live_update && cp.save_parent)return true;
            if (cp.changed || cp.hasCssChanges()) {
                var do_proj = false;
                if (cp.crsaProjectTemplate && savedProjects.indexOf(cp.crsaProjectTemplate) < 0) {
                    do_proj = true;
                    savedProjects.push(cp.crsaProjectTemplate)
                }
                cp.save(function () {
                    if (close_on_save) {
                        cp.$page.find(".crsa-close").trigger("click")
                    }
                }, true, true, false, do_proj)
            }
        })
    }, downloadAllPages: function () {
        crsaLoadScript("lib/jszip/jszip.js", function () {
            var $b = $('<p><i class="fa fa-refresh fa-spin"></i> Preparing the Zip file. Please wait...</p>');
            showAlert($b, "Download project");
            var zip = new JSZip;
            var doneAll = function () {
                $b.html('<a download="PinegrowProject.zip">Download the project Zip file</a></p><p>The zip file contains .html sources of all open pages, stylesheets in .css and .less format as well as Bootstrap files.');
                $a = $b.find("a");
                $a.attr("href", window.URL.createObjectURL(zip.generate({type: "blob"})))
            };
            var doneCss = function () {
                if (project) {
                    project.copyRequiredFilesToZip(zip, doneAll)
                } else {
                    doneAll()
                }
            };
            var project = null;
            $.each(crsaPages, function (i, cp) {
                zip.file(cp.name, cp.getSource(true));
                if (cp.crsaProjectTemplate)project = cp.crsaProjectTemplate;
                cp.setPageChanged(false)
            });
            var cslist = $.fn.crsacss("getAllCrsaStylesheets");
            var count = 0;
            $.each(cslist, function (i, cs) {
                count++;
                var less = cs.getLessSource();
                cs.getCssSource(function (css) {
                    setTimeout(function () {
                        zip.file(cs.name, css);
                        var less_name = cs.name.replace(/\.css$/i, ".less");
                        if (less_name == cs.name)less_name += ".less";
                        zip.file(less_name, less);
                        count--;
                        if (count == 0)doneCss()
                    }, 10)
                })
            });
            if (count == 0) {
                doneCss()
            }
        })
    }, addCustomPageAction: function (name, func) {
        customPageActions.push({name: name, func: func})
    }, addPage: function (src, loaded, providedCrsaPage, onLoadCanceled) {
        var name = getPageName(src);
        var _this = this;
        var $page = $("<div/>", {"class": "page"}).html('<span class="name">' + name + '</span><span class="page-changed">*</span><div class="content content-size-tablet-landscape"><iframe class="content-iframe" frameborder="0"></iframe></div>').appendTo(this);
        var $content = $page.find("div.content");
        $('<i class="fa fa-times crsa-close-icon"></i>').appendTo($page).on("click", function (e) {
            e.preventDefault();
            $page.find(".crsa-close").trigger("click")
        });
        var crsaPage;
        if (!providedCrsaPage) {
            crsaPage = new CrsaPage;
            crsaPage.name = name;
            crsaPage.url = src
        } else {
            crsaPage = providedCrsaPage
        }
        crsaPage.loading = true;
        crsaPage.$page = $page;
        crsaPage.$iframe = $page.find("iframe");
        crsaPage.setPageChanged(false, true);
        var $device = $("<div/>", {"class": "btn-group"}).html('<button type="button" class="btn btn-link btn-xs dropdown-toggle" data-toggle="dropdown">Page </button>                <ul class="dropdown-menu" role="menu">                </ul>').insertAfter($page.find(".page-changed"));
        var updateDeviceButtonList = function () {
            var $ul = $device.find("ul").html("");
            $.each(options.sizes, function (key, size) {
                $("<li/>").html('<a href="#">' + key + " / " + size + " px</a>").appendTo($ul).data("device-width", size)
            });
            $('<li class="divider"></li>').appendTo($ul);
            $('<li class="dropdown-header">Responsive breakpoints</li>').appendTo($ul);
            if (crsaPage.breakpoints.length > 0) {
                $("<li/>").html('<a href="#">&lt; ' + crsaPage.breakpoints[0] + " px</a>").appendTo($ul).data("device-width", Math.ceil(crsaPage.breakpoints[0] * .75));
                for (var i = 0; i < crsaPage.breakpoints.length; i++) {
                    $("<li/>").html('<a href="#">' + crsaPage.breakpoints[i] + " px</a>").appendTo($ul).data("device-width", crsaPage.breakpoints[i])
                }
                $("<li/>").html('<a href="#">&gt; ' + crsaPage.breakpoints[crsaPage.breakpoints.length - 1] + " px</a>").appendTo($ul).data("device-width", Math.ceil(crsaPage.breakpoints[crsaPage.breakpoints.length - 1] * 1.25))
            }
            $("<li/>").html('<a href="#">Manage breakpoints...</a>').appendTo($ul).on("click", function (e) {
                e.preventDefault();
                crsaPage.showManageBreakpoints()
            });
            $device.find(".btn").button();
            $device.find("a").on("click", function (e) {
                e.preventDefault();
                var w = $(e.delegateTarget).closest("li").data("device-width");
                if (w) {
                    crsaPage.deviceWidth = parseInt(w);
                    showDeviceValue();
                    methods.refresh();
                    $("body").trigger("crsa-window-changed", crsaPage)
                }
            })
        };
        updateDeviceButtonList();
        $("body").on("crsa-breakpoints-changed", function () {
            updateDeviceButtonList()
        });
        var setDeviceSize = function (w) {
            crsaPage.deviceWidth = parseInt(w);
            return;
            var dev = null;
            $.each(options.sizes, function (key, size) {
                if (size == w) {
                    dev = key;
                    return false
                }
                $content.removeClass("content-size-" + key)
            });
            $content.addClass("content-size-" + dev)
        };
        setDeviceSize(crsaPage.deviceWidth);
        var showDeviceValue = function () {
            var done = false;
            $.each(options.sizes, function (key, size) {
                if (crsaPage.deviceWidth == size) {
                    $device.find(">button").html(size + 'px <span class="caret"></span>');
                    done = true;
                    return false
                }
            });
            if (!done) {
                $device.find(">button").html(crsaPage.deviceWidth + 'px <span class="caret"></span>')
            }
        };
        showDeviceValue();
        var $action_menu = $("<div/>", {"class": "btn-group"}).html('<button type="button" class="btn btn-link btn-xs dropdown-toggle" data-toggle="dropdown">Page <span class="caret"></span></button>                <ul class="dropdown-menu with-checkboxes" role="menu">                </ul>').insertAfter($device);
        var $ul = $action_menu.find("ul");
        $("<li/>").html('<a href="#" class="crsa-view">Open another view</a>').appendTo($ul);
        $("<li/>").html('<a href="#" class="crsa-clone">Duplicate</a>').appendTo($ul);
        $("<li/>").html('<a href="#" class="crsa-reload">Revert to saved</a>').appendTo($ul);
        var $refa = $("<li/>").html('<a href="#" class="crsa-refresh">Refresh</a>').appendTo($ul);
        crsaAddKbd($refa.find("a"), "CMD R");
        if (!isApp()) {
            $("<li/>").html('<a href="#" class="crsa-rename">Rename</a>').appendTo($ul)
        }
        $("<li/>").html('<a href="#" class="crsa-manage-ss">Manage stylesheets...</a>').appendTo($ul);
        $("<li/>").html('<a href="#" class="crsa-manage-fm">Manage frameworks...</a>').appendTo($ul);
        var $edit = $("<li/>").html('<a href="#" class="crsa-code">Edit code</a>').appendTo($ul);
        crsaAddKbd($edit.find("a"), "CMD E");
        if (isApp()) {
            var $openPreview = $("<li/>").html('<a href="#" target="_blank" class="crsa-preview"><i class="fa fa-link"></i>Preview in browser</a>').appendTo($ul);
            var $savepreview = $("<li/>").html('<a href="#" target="_blank" class="crsa-save-preview">Save &amp; Open in browser</a>');
            $ul.find("a.crsa-preview i").on("click", function (e) {
                if (isApp()) {
                    var gui = require("nw.gui");
                    var clipboard = gui.Clipboard.get();
                    var $link = $(e.delegateTarget).closest("a");
                    clipboard.set(crsaPage.getPreviewUrl(), "text");
                    $link.tooltip({
                        container: "body",
                        placement: "left",
                        title: "Link to the page was copied to the clipboard.",
                        trigger: "manual"
                    });
                    $link.tooltip("show");
                    setTimeout(function () {
                        $link.tooltip("destroy")
                    }, 2500);
                    e.stopPropagation();
                    e.preventDefault()
                }
            });
            var openInBrowser = function (url) {
                var gui = require("nw.gui");
                var url = crsaPage.getPreviewUrl(true);
                if (url.indexOf("file://") == -10) {
                    url = url.replace("file://", "");
                    gui.Shell.openItem(url)
                } else {
                    gui.Shell.openExternal(url)
                }
                pinegrow.showNotice("<p>The page was opened in your default browser. Click on <b>the link icon</b> next to Page -&gt; Preview in Browser to <b>copy the preview link to clipboard</b> from where you can use it to open the preview in any browser.</p><p>The preview link will work as long as the page is opened in Pinegrow.</p>", "About the preview link", "page-preview-link")
            };
            $ul.find("a.crsa-preview").attr("href", src).on("click", function (e) {
                if (isApp()) {
                    openInBrowser($(e.delegateTarget).attr("href"));
                    e.preventDefault()
                }
            });
            crsaAddKbd($openPreview.find("a"), "CMD B");
            $ul.find("a.crsa-save-preview").attr("href", src).on("click", function (e) {
                e.preventDefault();
                if (isApp()) {
                    var cp = pinegrow.getSelectedPage();
                    if (cp.live_update && cp.save_parent)cp = cp.live_update;
                    cp.save(function (err) {
                        openInBrowser(cp.url)
                    }, true, true)
                }
            })
        }
        if (customPageActions && customPageActions.length > 0) {
            $("<li/>", {"class": "divider"}).appendTo($ul);
            $.each(customPageActions, function (i, pa) {
                (function (pa) {
                    $("<li/>").html('<a href="#" class="crsa-custom-action">' + pa.name + "</a>").appendTo($ul).on("click", function (e) {
                        e.preventDefault();
                        if (pa.func) {
                            pa.func(crsaPage)
                        }
                    })
                })(pa)
            })
        }
        $("<li/>", {"class": "divider"}).appendTo($ul);
        $("<li/>").html('<a href="#" class="crsa-page-scroll"><i class="fa fa-check"></i>Scrollbars</a>').appendTo($ul);
        $("<li/>").html('<a href="#" class="crsa-page-no-anim"><i class="fa fa-check"></i>Disable CSS Animations</a>').appendTo($ul);
        $("<li/>", {"class": "divider"}).appendTo($ul);
        $("<li/>").html('<a href="#" class="crsa-close">Close</a>').appendTo($ul);
        $("<li/>").html('<a href="#" class="crsa-close-leave-css">Close HTML, keep CSS</a>').appendTo($ul);
        $action_menu.find(".btn").button();
        if (isApp()) {
            crsaPage.$iframe.attr("nwdisable", "nwdisable").attr("nwfaketop", "nwfaketop")
        }
        crsaPages.push(crsaPage);
        crsaPage.$iframe.data("crsa-page", crsaPage);
        methods.reloadPage(crsaPage, function (a, b) {
            if (loaded)loaded(a, b)
        }, onLoadCanceled);
        $page.find("span.name").html(crsaPage.name);
        $page.find(".crsa-code").on("click", function (e) {
            $("body").crsa("editCode", $page.find("iframe"));
            e.preventDefault()
        });
        var $scroll = $page.find(".crsa-page-scroll").on("click", function (e) {
            crsaPage.scrollMode = !crsaPage.scrollMode;
            updateCheckbox($(e.delegateTarget), crsaPage.scrollMode);
            crsaPage.autoSize();
            e.preventDefault()
        });
        var $anim = $page.find(".crsa-page-no-anim").on("click", function (e) {
            if (crsaPage.hasStoppedAnimations()) {
                crsaPage.startAnimations()
            } else {
                crsaPage.stopAnimations()
            }
            updateCheckbox($(e.delegateTarget), crsaPage.hasStoppedAnimations());
            crsaPage.autoSize();
            e.preventDefault()
        });
        var updateCheckbox = function ($li, value) {
            var $i = $li.find("i");
            if (value) {
                $i.css("opacity", 1)
            } else {
                $i.css("opacity", 0)
            }
        };
        updateCheckbox($scroll, crsaPage.scrollMode);
        updateCheckbox($anim, crsaPage.animationsStopped);
        var closePage = function (leave_css) {
            var $iframe = $page.find("iframe");
            _this.trigger("crsa-page-closed", crsaPage);
            var ps = getCrsaPageStylesForPage($iframe);
            if (ps && !leave_css) {
                ps.removeAllExclusiveSheets()
            }
            var idx = crsaPages.indexOf(crsaPage);
            if (idx >= 0)crsaPages.splice(idx, 1);
            crsaPage.$iframe.off(".crsa").attr("src", "about:blank");
            for (var i = 0; i < crsaPages.length; i++) {
                if (crsaPages[i].live_update == crsaPage) {
                    crsaPages[i].setLiveUpdate(null)
                }
            }
            crsaPage.setLocalFile(null);
            crsaPage.$iframe.remove();
            crsaPage.$iframe = null;
            crsaPage.$page = null;
            $page.remove();
            updatePagesList(_this);
            methods.refresh();
            $("body").trigger("crsa-stylesheets-changed")
        };
        var ask_close_html = "This page has unsaved changed. Are you sure you want to close it?";
        var ask_close_css = "Stylesheets attached to this page have unsaved changes. Are you sure you want to proceed?";
        $page.find(".crsa-close").on("click", function (e) {
            var ask = null;
            if (crsaPage.hasCssChanges()) {
                ask = ask_close_css
            }
            if (crsaPage.changed && !crsaPage.force_close) {
                ask = ask_close_html
            }
            if (ask) {
                showAlert(ask, "Page has unsaved changes", "Don't close", "Close", null, function () {
                    closePage()
                })
            } else {
                closePage()
            }
            e.preventDefault()
        });
        $page.find(".crsa-close-leave-css").on("click", function (e) {
            var ask = null;
            if (crsaPage.changed) {
                ask = ask_close_html
            }
            if (ask) {
                showAlert(ask, "Page has unsaved changes", "Don't close", "Close", null, function () {
                    closePage(true)
                })
            } else {
                closePage(true)
            }
            e.preventDefault()
        });
        $page.find(".crsa-manage-ss").on("click", function (e) {
            var $iframe = $page.find("iframe");
            $.fn.crsa("setSelectedPage", $iframe);
            $.fn.crsacss("showStylesheetsManager");
            e.preventDefault()
        });
        $page.find(".crsa-manage-fm").on("click", function (e) {
            $.fn.crsacss("showFrameworkManager", crsaPage);
            e.preventDefault()
        });
        $page.find(".crsa-clone").on("click", function (e) {
            _this.trigger("crsa-page-clone", crsaPage);
            e.preventDefault()
        });
        $page.find(".crsa-view").on("click", function (e) {
            _this.trigger("crsa-page-view", crsaPage);
            e.preventDefault()
        });
        $page.find(".crsa-mirror").on("click", function (e) {
            _this.trigger("crsa-page-mirror", crsaPage);
            e.preventDefault()
        });
        $page.find(".crsa-reload").on("click", function (e) {
            _this.trigger("crsa-page-reload", crsaPage);
            e.preventDefault()
        });
        $page.find(".crsa-refresh").on("click", function (e) {
            _this.trigger("crsa-page-refresh", crsaPage);
            e.preventDefault()
        });
        $page.find(".crsa-rename").on("click", function (e) {
            _this.trigger("crsa-page-rename", crsaPage);
            e.preventDefault()
        });
        $page.find(".crsa-preview").on("click", function (e) {
        });
        updatePagesList(this);
        methods.refresh();
        return this
    }, checkIfPageExists: function (url, done) {
        if (isApp() && crsaIsFileUrl(url)) {
            var file = crsaMakeFileFromUrl(url, true);
            if (crsaIsFileOrDir(file) == "file") {
                done(true)
            } else {
                console.log("File " + file + " not found.");
                done(false)
            }
        } else {
            $.ajax({url: url, data: null, dataType: "html"}).done(function (data) {
                done(true)
            }).fail(function (a, b, c) {
                done(false)
            })
        }
    }, reloadPage: function (crsaPage, done, onCancel, refresh) {
        if (!refresh)crsaPage.loadingStart(onCancel);
        var onPageLoaded = function () {
            var page_loaded_called = false;
            if (crsaPage.load_source) {
                page_loaded_called = true;
                crsaPage.setSource(crsaPage.load_source, null, true);
                crsaPage.load_source = null;
                crsaPage.runScripts(function () {
                    crsaPage.callFrameworkHandler("on_page_loaded");
                    $.fn.crsa("updateIfNeeded")
                })
            }
            crsaPage.loaded = true;
            if (!refresh) {
                crsaPage.setPageChanged(false);
                var loaded_url = crsaPage.$iframe.get(0).contentDocument.location.href;
                loaded_url = crsaPage.getPageUrlFromLoadedUrl(loaded_url);
                if (loaded_url != crsaPage.url) {
                    crsaPage.rename(loaded_url);
                    crsaPage.pageLoaded()
                }
            }
            if (done)done(crsaPage.$iframe, crsaPage, refresh);
            if (!page_loaded_called) {
                if (refresh) {
                    crsaPage.callFrameworkHandler("on_page_refreshed")
                } else {
                    crsaPage.callFrameworkHandler("on_page_loaded")
                }
            }
            crsaPage.addCrsaStyles();
            setTimeout(function () {
                methods.autoSizePage(crsaPage.$iframe, crsaPage.scrollMode)
            }, 1);
            if (crsaPage.animationsStopped) {
                crsaPage.stopAnimations();
                if (!refresh)crsaQuickMessage("CSS Animations stopped.", 2e3)
            } else {
                crsaPage.startAnimations()
            }
            crsaPage.$iframe.get(0).contentWindow.onbeforeunload = function (e) {
                return crsaPage.allowReload || !crsaGetCustomLogic().warnOnUnloadPage ? null : "You will not be able to continue editing this page if you navigate away from it."
            };
            crsaPage.allowReload = false;
            $(crsaPage.getDocument()).off("click.crsa").on("click.crsa", function () {
                $("body").trigger("click")
            })
        };
        var doWithExists = function (exists) {
            if (!refresh) {
                crsaPage.$iframe.off("load.crsa").on("load.crsa", function (event) {
                    console.log("iframe load");
                    if (!exists) {
                        crsaPage.setSource('<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></head><body><p>New page</p></body>', null, false);
                        pinegrow.showNotice("<p>Reasons for file not being found could be:</p><ul><li>Using <b>semicolons ;</b>, <b>?</b> or <b>#</b> in file path is not supported.</li></ul>", "File was not found", "file-not-found")
                    }
                    onPageLoaded()
                });
                crsaPage.$iframe.off("frame-document-start.crsa")
            } else {
                crsaPage.$iframe.off("load.crsa").on("load.crsa", function (event) {
                    console.log("iframe loaded");
                    crsaPage.addCrsaStyles()
                });
                crsaPage.$iframe.off("frame-document-start.crsa").on("frame-document-start.crsa", function () {
                    console.log("frame-document-start");
                    onPageLoaded()
                })
            }
            var pgurl;
            var args = ["pgid=" + crsaPage.uid, "pgedit=1"];
            if (refresh)args.push("pglive=1");
            pgurl = crsaPage.getCompatibleUrl(crsaPage.url);
            pgurl = crsaAppendQueryToUrl(pgurl, args);
            crsaPage.allowReload = true;
            console.log("Loading " + pgurl);
            crsaPage.$iframe.attr("src", pgurl)
        };
        if (!refresh) {
            methods.checkIfPageExists(crsaPage.url, function (exists) {
                doWithExists(exists)
            })
        } else {
            doWithExists(true)
        }
    }, showOverlays: function (hide) {
        pages.each(function (i, p) {
            var $p = $(p);
            var $if = $p.find(".content-iframe");
            var $c = $p.find(".content");
            var $o = $p.find(".iframe-overlay");
            if (!hide) {
                if ($o.length == 0) {
                    $o = $("<div/>", {"class": "iframe-overlay"}).appendTo($c).data("iframe_element", $if).css("top", $if.position().top + "px")
                }
            } else {
                $o.remove()
            }
        })
    }, showLoadingOverlay: function ($p, hide, onCancel) {
        var $if = $p.find(".content-iframe");
        var $c = $p.find(".content");
        var $o = $p.find(".iframe-loading-overlay");
        if (!hide) {
            if ($o.length == 0) {
                $o = $("<div/>", {"class": "iframe-loading-overlay"}).html('<div><i class="fa fa-refresh fa-spin"></i>Loading, please wait...<p style="padding-left:40px;padding-right:40px;"><small>If the page doesn\'t load check your firewall settings or / and try changing the internal web server port in Support -&gt; Settings.</small></p></div>').appendTo($c).css("top", $if.position().top + "px");
                $o.find("a").on("click", function (e) {
                    e.preventDefault();
                    methods.showLoadingOverlay($p, true);
                    if (onCancel)onCancel()
                })
            }
        } else {
            $o.remove()
        }
    }, getZoom: function () {
        return currentZoom
    }, refresh: function () {
        var cw = 0;
        var $code = $("#textedit");
        if ($code.is(":visible")) {
            cw = $code.width() + 5
        }
        methods.centerPages(centerLeft, ($("#crsa-tree").is(":visible") ? $("#crsa-tree").width() : 10) + cw);
        if (fitZoom) {
            methods.zoom(getFitZoomScale())
        } else {
            methods.zoom(currentZoom)
        }
    }, autoSizePage: function ($if, scroll_mode) {
        sizePage($if, currentZoom, scroll_mode)
    }, setFit: function (fit) {
        fitZoom = fit;
        methods.refresh()
    }, getFit: function (fit) {
        return fitZoom
    }, canvasResized: function () {
        methods.refresh();
        return;
        if (fitZoom) {
            methods.zoom(getFitZoomScale())
        }
    }, zoom: function (zoom) {
        var $pages = pages.find("> div.content");
        var $iframes = pages.find("iframe");
        var w = 800;
        currentZoom = zoom;
        $pages.each(function (i, e) {
            var $e = $(e);
            var $if = $e.find("iframe");
            var cp = getCrsaPageForIframe($if);
            w = cp.deviceWidth;
            var cw = Math.ceil(w * zoom);
            $if.css("height", "").css("width", w + "px").css("transform", "scale(" + zoom + ", " + zoom + ")").css("transform-origin", "0 0");
            sizePage($if, zoom, cp.scrollMode, w);
            $if.data("zoom", zoom)
        });
        $.fn.crsa("refreshSelectElement");
        return this
    }, centerPages: function (leftp, rightp) {
        centerLeft = leftp;
        centerRight = rightp;
        var $canvas = $("div.canvas");
        var w = $canvas.outerWidth();
        var space = w - leftp - rightp;
        var margin = 20;
        var $pages = $canvas.find("div.page");
        var pagew = $pages.width() + margin;
        var pagesPerLine = Math.floor(space / pagew);
        if (pagesPerLine < 1)pagesPerLine = 1;
        if (pagesPerLine > $pages.length)pagesPerLine = $pages.length;
        var pagesWidth = pagew * pagesPerLine;
        var paddingLeft = leftp + (space - pagesWidth) / 2 - 20;
        var paddingRight = rightp + (space - pagesWidth) / 2 - 20;
        paddingLeft = centerLeft;
        paddingRight = centerRight;
        $canvas.css("overflow-y", "auto").css("overflow-x", "auto").css("margin-left", paddingLeft + "px").css("margin-right", paddingRight + 0 + "px")
    }
};
var getFitZoomScale = function () {
    var spc = 24;
    var w = 0, sw = spc;
    $.each(crsaPages, function (i, cp) {
        w += cp.deviceWidth;
        sw += spc
    });
    var space = $("div.canvas").width();
    var z = (space - sw) / w;
    var min = 230;
    w = 0;
    sw = spc;
    do {
        var all_min = true;
        var len = sw;
        $.each(crsaPages, function (i, cp) {
            if (cp.deviceWidth * z < min) {
                len += min
            } else {
                len += cp.deviceWidth * z;
                all_min = false
            }
            len += spc
        });
        if (len > space)z = z * .95
    } while (!all_min && len > space);
    if (z > 1)z = 1;
    return z
};
var sizePage = function ($if, zoom, scroll_mode, w) {
    var $e = $if.closest(".content");
    if (!w)w = $if.width();
    var cw = Math.ceil(w * zoom);
    $if.css("height", "");
    var h;
    var eh;
    if (scroll_mode) {
        var bh = $body.height() - 90;
        h = bh / zoom;
        eh = bh
    } else {
        h = Math.ceil($if[0].contentWindow.document.body.scrollHeight * 1.05);
        eh = Math.ceil(h * zoom)
    }
    $if.css("height", h + "px").css("width", w + "px");
    $e.css("width", cw + "px").css("height", eh + "px")
};
var updatePagesList = function ($el) {
    $el.each(function (i, e) {
        pages = $(e).find("div.page")
    });
    if (pages.length == 0) {
        $empty.show()
    } else {
        $empty.hide()
    }
};
$.fn.crsapages.defaults = {
    title: "crsa",
    sizes: {desktop: 1600, laptop: 1280, "tablet-landscape": 1024, "tablet-portrait": 768, phone: 320}
};
function getIframeBody(iframe) {
    var doc = iframe.contentDocument || iframe.contentWindow.document;
    return doc.body
}
function getIframeHtmlElement(iframe) {
    var doc = iframe.contentDocument || iframe.contentWindow.document;
    var head = doc.getElementsByTagName("html")[0];
    return head
}
function getIframeHead(iframe) {
    var doc = iframe.contentDocument || iframe.contentWindow.document;
    var head = doc.getElementsByTagName("head")[0];
    return head
}
function getIframeTag(iframe, tag) {
    var doc = iframe.contentDocument || iframe.contentWindow.document;
    var head = doc.getElementsByTagName(tag)[0];
    return head
}